name: CI
on:
  push:
  schedule:
    - cron: "0 3 * * 2" # Every Tuesday at 3:00

jobs:
  crystal-style:
    uses: PlaceOS/.github/.github/workflows/crystal-style.yml@main

  dockerfile-style:
    uses: PlaceOS/.github/.github/workflows/dockerfile-style.yml@main

  test:
    name: "crystal: ${{ matrix.crystal }}, stable: ${{ matrix.stable }}"
    continue-on-error: ${{ !matrix.stable }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        stable: [true]
        crystal:
          - 1.1.1
          - 1.2.2
          - 1.3.2
          - 1.4.0
        include:
          - crystal: nightly
            stable: false
    steps:
      - uses: actions/checkout@v2
      - name: Run docker-compose test environment
        run: ./test
        env:
            CRYSTAL_VERSION: ${{ matrix.crystal }}
      - run: docker-compose logs build
        if: ${{ failure() }}
